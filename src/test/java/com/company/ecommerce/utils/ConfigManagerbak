// src/test/java/com/company/ecommerce/utils/ConfigManager.java
package com.company.ecommerce.utils;

import java.io.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class ConfigManagerbak {

    private static volatile ConfigManagerbak instance;
    private final Properties properties = new Properties();
    private final Map<String, Object> cache = new ConcurrentHashMap<>();
    private static final String DEFAULT_ENVIRONMENT = "dev";
    private static final String CONFIG_DIR = "config/";

    // 环境变量前缀
    private static final String ENV_PREFIX = "ECOMMERCE_";

    // 配置加载状态
    private boolean isLoaded = false;

    private ConfigManagerbak() {
        // 私有构造函数，单例模式
    }

    /**
     * 获取单例实例
     */
    public static ConfigManagerbak getInstance() {
        if (instance == null) {
            synchronized (ConfigManagerbak.class) {
                if (instance == null) {
                    instance = new ConfigManagerbak();
                    // 自动加载配置
//                    instance.autoLoadConfig();
                }
            }
        }
        return instance;
    }

    public static String getApiSecretKey() {
        return null;
    }

    /**
     * 自动加载配置（支持环境变量和系统属性）
     */
    private void autoLoadConfig() {
        if (isLoaded) {
            return;
        }

        // 1. 确定环境
        String environment = determineEnvironment();

        // 2. 加载配置文件
        loadConfig(environment);

        // 3. 加载环境变量（优先级高于配置文件）
        loadEnvironmentVariables();

        // 4. 加载系统属性（优先级最高）
        loadSystemProperties();

        isLoaded = true;
        System.out.println("配置加载完成，当前环境: " + environment);
    }

    /**
     * 确定运行环境
     */
    private String determineEnvironment() {
        // 优先级：命令行参数 > 环境变量 > 默认值
        String env = System.getProperty("env");
        if (env == null || env.trim().isEmpty()) {
            env = System.getenv("APP_ENV");
        }
        if (env == null || env.trim().isEmpty()) {
            env = System.getenv("ENVIRONMENT");
        }
        return env != null ? env : DEFAULT_ENVIRONMENT;
    }

    /**
     * 加载配置文件
     */
    public void loadConfig(String environment) {
        String configFile = environment + ".properties";
        String configPath = CONFIG_DIR + configFile;

        try (InputStream input = getClass().getClassLoader().getResourceAsStream(configPath)) {
            if (input == null) {
                System.err.println("警告: 找不到配置文件: " + configPath);
                // 尝试加载默认配置文件
                loadDefaultConfig();
                return;
            }

            properties.load(input);
            System.out.println("已加载配置文件: " + configPath);

            // 加载通用配置文件
            loadCommonConfig();

        } catch (IOException e) {
            throw new RuntimeException("加载配置文件失败: " + configPath, e);
        }
    }

    /**
     * 加载默认配置
     */
    private void loadDefaultConfig() {
        try (InputStream input = getClass().getClassLoader()
                .getResourceAsStream(CONFIG_DIR + "application.properties")) {
            if (input != null) {
                properties.load(input);
                System.out.println("已加载默认配置文件: application.properties");
            }
        } catch (IOException e) {
            System.err.println("无法加载默认配置文件");
        }
    }

    /**
     * 加载通用配置
     */
    private void loadCommonConfig() {
        try (InputStream input = getClass().getClassLoader()
                .getResourceAsStream(CONFIG_DIR + "common.properties")) {
            if (input != null) {
                Properties commonProps = new Properties();
                commonProps.load(input);

                // 合并配置，common 配置作为默认值
                for (String key : commonProps.stringPropertyNames()) {
                    if (!properties.containsKey(key)) {
                        properties.setProperty(key, commonProps.getProperty(key));
                    }
                }
                System.out.println("已加载通用配置文件");
            }
        } catch (IOException e) {
            // 忽略，通用配置文件不是必需的
        }
    }

    /**
     * 加载环境变量
     */
    private void loadEnvironmentVariables() {
        Map<String, String> env = System.getenv();
        for (Map.Entry<String, String> entry : env.entrySet()) {
            String key = entry.getKey();
            if (key.startsWith(ENV_PREFIX)) {
                // 转换环境变量格式：ECOMMERCE_NOTIFICATIONS_ENABLED -> notifications.enabled
                String normalizedKey = key.substring(ENV_PREFIX.length())
                        .toLowerCase()
                        .replace('_', '.');
                properties.setProperty(normalizedKey, entry.getValue());
            }
        }
    }

    /**
     * 加载系统属性
     */
    private void loadSystemProperties() {
        Properties sysProps = System.getProperties();
        for (String key : sysProps.stringPropertyNames()) {
            if (key.startsWith("ecommerce.") || key.startsWith("app.")) {
                properties.setProperty(key, sysProps.getProperty(key));
            }
        }
    }



    /**
     * 获取整数配置
     */
    public int getInt(String key) {
        String value = getProperty(key);
        if (value == null) {
            throw new ConfigException("配置项未找到: " + key);
        }
        try {
            return Integer.parseInt(value.trim());
        } catch (NumberFormatException e) {
            throw new ConfigException("配置项格式错误（期望整数）: " + key + " = " + value);
        }
    }

    public int getInt(String key, int defaultValue) {
        String value = getProperty(key);
        if (value == null) {
            return defaultValue;
        }
        try {
            return Integer.parseInt(value.trim());
        } catch (NumberFormatException e) {
            System.err.println("配置项格式错误（期望整数）: " + key + " = " + value + "，使用默认值: " + defaultValue);
            return defaultValue;
        }
    }

    /**
     * 获取布尔配置
     */
    public boolean getBoolean(String key) {
        String value = getProperty(key);
        if (value == null) {
            throw new ConfigException("配置项未找到: " + key);
        }
        return Boolean.parseBoolean(value.trim());
    }

    public boolean getBoolean(String key, boolean defaultValue) {
        String value = getProperty(key);
        if (value == null) {
            return defaultValue;
        }
        return Boolean.parseBoolean(value.trim());
    }

    /**
     * 获取长整数配置
     */
    public long getLong(String key) {
        String value = getProperty(key);
        if (value == null) {
            throw new ConfigException("配置项未找到: " + key);
        }
        try {
            return Long.parseLong(value.trim());
        } catch (NumberFormatException e) {
            throw new ConfigException("配置项格式错误（期望长整数）: " + key + " = " + value);
        }
    }

    public long getLong(String key, long defaultValue) {
        String value = getProperty(key);
        if (value == null) {
            return defaultValue;
        }
        try {
            return Long.parseLong(value.trim());
        } catch (NumberFormatException e) {
            System.err.println("配置项格式错误（期望长整数）: " + key + " = " + value + "，使用默认值: " + defaultValue);
            return defaultValue;
        }
    }

    /**
     * 获取双精度浮点数配置
     */
    public double getDouble(String key) {
        String value = getProperty(key);
        if (value == null) {
            throw new ConfigException("配置项未找到: " + key);
        }
        try {
            return Double.parseDouble(value.trim());
        } catch (NumberFormatException e) {
            throw new ConfigException("配置项格式错误（期望浮点数）: " + key + " = " + value);
        }
    }

    public double getDouble(String key, double defaultValue) {
        String value = getProperty(key);
        if (value == null) {
            return defaultValue;
        }
        try {
            return Double.parseDouble(value.trim());
        } catch (NumberFormatException e) {
            System.err.println("配置项格式错误（期望浮点数）: " + key + " = " + value + "，使用默认值: " + defaultValue);
            return defaultValue;
        }
    }

    /**
     * 获取列表配置（逗号分隔）
     */
    public List<String> getList(String key) {
        String value = getProperty(key);
        if (value == null) {
            return new ArrayList<>();
        }
        return Arrays.asList(value.split("\\s*,\\s*"));
    }

    public List<String> getList(String key, List<String> defaultValue) {
        String value = getProperty(key);
        if (value == null) {
            return defaultValue;
        }
        return Arrays.asList(value.split("\\s*,\\s*"));
    }

    /**
     * 动态设置配置值（运行时）
     */
    public void setProperty(String key, String value) {
        properties.setProperty(key, value);
        // 清除相关缓存
        cache.remove(key);
    }

    /**
     * 检查配置是否存在
     */
    public boolean containsKey(String key) {
        return properties.containsKey(key);
    }

    /**
     * 重新加载配置
     */
    public void reload() {
        synchronized (this) {
            properties.clear();
            cache.clear();
            isLoaded = false;
            autoLoadConfig();
        }
    }

    /**
     * 获取所有配置
     */
    public Properties getAllProperties() {
        Properties copy = new Properties();
        copy.putAll(properties);
        return copy;
    }

    /**
     * 打印配置（调试用）
     */
    public void printConfig() {
        System.out.println("=== 当前配置 ===");
        properties.stringPropertyNames().stream()
                .sorted()
                .forEach(key -> System.out.println(key + " = " + properties.getProperty(key)));
        System.out.println("================");
    }

    // ========== 原有的便捷方法（保持兼容） ==========

    public static String getAppUrl() {
        return getInstance().getProperty("app.url");
    }

    public static String getApiBaseUrl() {
        return getInstance().getProperty("api.base.url");
    }

    public static String getApiBasePath() {
        return getInstance().getProperty("api.base.path");
    }

    public static String getTestUsername() {
        return getInstance().getProperty("test.username");
    }

    public static String getTestPassword() {
        return getInstance().getProperty("test.password");
    }

    public static String getApiToken() {
        return getInstance().getProperty("api.token");
    }

    public static boolean isScreenshotOnFailure() {
        return getInstance().getBoolean("screenshot.on.failure", true);
    }

    public static String getScreenshotBaseDir() {
        return getInstance().getProperty("screenshot.base.dir", "test-results/screenshots");
    }

    public static int getScreenshotKeepDays() {
        return getInstance().getInt("screenshot.keep.days", 30);
    }

    public static boolean isReportEnabled() {
        return getInstance().getBoolean("report.enabled", true);
    }

    public static String getReportBaseDir() {
        return getInstance().getProperty("report.base.dir", "test-results/html-reports");
    }

    public static String getReportTheme() {
        return getInstance().getProperty("report.theme", "DARK");
    }

    // ========== 新的便捷方法 ==========

    public static boolean isNotificationsEnabled() {
        return getInstance().getBoolean("notifications.enabled", false);
    }

    public static String getNotificationType() {
        return getInstance().getProperty("notifications.type", "email");
    }

    public static String getEnvironment() {
        return getInstance().getProperty("environment", "dev");
    }

    public static String getProjectName() {
        return getInstance().getProperty("project.name", "E-commerce Automation");
    }

    public static String getEmailSmtpHost() {
        return getInstance().getProperty("email.smtp.host");
    }

    public static String getEmailSmtpPort() {
        return getInstance().getProperty("email.smtp.port", "587");
    }

    public static String getEmailUsername() {
        return getInstance().getProperty("email.username");
    }

    public static String getEmailPassword() {
        return getInstance().getProperty("email.password");
    }

    public static String getEmailFrom() {
        return getInstance().getProperty("email.from");
    }

    public static List<String> getEmailTo() {
        return getInstance().getList("email.to");
    }

    public static String getSlackWebhookUrl() {
        return getInstance().getProperty("slack.webhook.url");
    }

    public static String getSlackChannel() {
        return getInstance().getProperty("slack.channel", "#test-notifications");
    }

    public static String getDingTalkWebhookUrl() {
        return getInstance().getProperty("dingtalk.webhook.url");
    }

    public static String getWeChatWebhookUrl() {
        return getInstance().getProperty("wechat.webhook.url");
    }

    /**
     * 配置异常类
     */
    public static class ConfigException extends RuntimeException {
        public ConfigException(String message) {
            super(message);
        }

        public ConfigException(String message, Throwable cause) {
            super(message, cause);
        }
    }

    // ========== 静态辅助方法（保持兼容） ==========

    /**
     * @deprecated 使用 getInstance().getProperty() 替代
     */
    @Deprecated
    public static String getProperty(String key, String defaultValue) {
        return getInstance().getProperty(key, defaultValue);
    }

    /**
     * @deprecated 使用 getInstance().getProperty() 替代
     */
    @Deprecated
    public static String getProperty(String key) {
        return getInstance().getProperty(key);
    }

    /**
     * @deprecated 使用 getInstance().getInt() 替代
     */
    @Deprecated
    public static int getIntProperty(String key, int defaultValue) {
        return getInstance().getInt(key, defaultValue);
    }

    /**
     * @deprecated 使用 getInstance().getBoolean() 替代
     */
    @Deprecated
    public static boolean getBooleanProperty(String key, boolean defaultValue) {
        return getInstance().getBoolean(key, defaultValue);
    }


}